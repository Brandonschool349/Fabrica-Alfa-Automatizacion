<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F√°brica Alfa ‚Äî Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;            /* dark bg */
      --card:#0b1220;          /* card dark */
      --accent:linear-gradient(90deg,#6a5af9,#00c2ff);
      --muted:#93a0b5;
    }
    body{ font-family: "Inter", Arial, sans-serif; background:linear-gradient(180deg,#f3f6f9,#eef3fb); color:#111;}
    .app {
      max-width:1200px; margin:28px auto;
    }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo {
      width:56px; height:56px; border-radius:12px;
      background:linear-gradient(180deg,#6a5af9,#00c2ff); display:flex; align-items:center; justify-content:center;
      color:white; font-weight:700; box-shadow:0 8px 30px rgba(74,44,221,0.12);
    }
    .sidebar {
      background: #071028; color:#fff; border-radius:12px; padding:18px;
      min-width:220px; max-width:260px;
    }
    .card-glass { background: #ffffff; border-radius:12px; padding:18px; box-shadow: 0 8px 30px rgba(30,40,60,0.06); }
    .nav-btn { width:100%; text-align:left;}
    .small-muted { color:var(--muted); font-size:0.9rem;}
    .metric { font-weight:700; font-size:1.25rem; }
    .chart-card { min-height:260px; }
    .hidden { display:none !important; }
    footer { text-align:center; color:#6b7280; margin-top:30px; font-size:0.9rem;}
  </style>
</head>
<body>
  <div class="app">

    <!-- header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="brand">
        <div class="logo">FA</div>
        <div>
          <h3 style="margin:0">Dashboard Anal√≠tico ‚Äî <span style="color:#4b6bff">F√°brica Alfa</span></h3>
          <div class="small-muted">Prototipo de anal√≠tica y control de producci√≥n</div>
        </div>
      </div>

      <div id="userPanel" class="text-end">
        <!-- when logged -->
        <div id="notLogged">
          <button class="btn btn-outline-primary" onclick="showLogin()">Iniciar sesi√≥n</button>
        </div>
        <div id="logged" class="hidden">
          <div><strong id="userNameDisplay"></strong></div>
          <button class="btn btn-sm btn-danger mt-2" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>

    <div class="d-flex gap-4">
      <!-- SIDEBAR -->
      <div class="sidebar">
        <h6 class="text-uppercase small-muted">Men√∫</h6>
        <div class="mt-3">
          <button class="btn btn-sm btn-light mb-2 nav-btn" onclick="navTo('dashboard')">üè† Panel principal</button>
          <button class="btn btn-sm btn-light mb-2 nav-btn" onclick="navTo('supervisor')">üõ† Supervisor</button>
          <button class="btn btn-sm btn-light mb-2 nav-btn" onclick="navTo('gerente')">üìà Gerente</button>
          <hr style="border-color:rgba(255,255,255,0.06)">
          <div class="small-muted">API</div>
          <div class="mt-2 small-muted">Conexi√≥n: <span id="apiStatus">desconocida</span></div>
        </div>
      </div>

      <!-- MAIN -->
      <div style="flex:1">

        <!-- LOGIN MODAL (simple) -->
        <div id="loginModal" class="card-glass mb-4 hidden">
          <h5>Iniciar sesi√≥n</h5>
          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <input id="loginUser" class="form-control" placeholder="Usuario (admin / supervisor)">
            </div>
            <div class="col-md-6">
              <input id="loginPass" type="password" class="form-control" placeholder="Contrase√±a">
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100 mt-2" onclick="doLogin()">Entrar</button>
            </div>
            <div class="col-12">
              <div id="loginMsg" class="small-muted mt-2"></div>
            </div>
          </div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboardView">
          <!-- Upload card -->
          <div class="card-glass mb-4">
            <h5>üìÅ Cargar base de datos (Excel/CSV)</h5>
            <div class="row g-3 align-items-center mt-2">
              <div class="col-md-8">
                <input id="fileInput" type="file" class="form-control">
              </div>
              <div class="col-md-4">
                <button class="btn btn-dark w-100" onclick="uploadFile()">Cargar archivo</button>
              </div>
              <div class="col-12"><small id="uploadMsg" class="small-muted"></small></div>
            </div>
          </div>

          <!-- metrics row -->
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="card-glass">
                <div class="small-muted">Medidas de tendencia central</div>
                <input id="colTend" class="form-control mt-2" placeholder="Ej: Ventas">
                <button class="btn btn-primary w-100 mt-3" onclick="calcTend()">Calcular</button>
                <div class="mt-3">
                  <div class="small-muted">Media</div><div id="mediaVal" class="metric">‚Äî</div>
                  <div class="small-muted">Mediana</div><div id="medianaVal" class="metric">‚Äî</div>
                  <div class="small-muted">Moda</div><div id="modaVal" class="metric">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="card-glass">
                <div class="small-muted">Medidas de dispersi√≥n</div>
                <input id="colDisp" class="form-control mt-2" placeholder="Ej: Unidades">
                <button class="btn btn-warning w-100 mt-3" onclick="calcDisp()">Calcular</button>
                <div class="mt-3">
                  <div class="small-muted">Desviaci√≥n</div><div id="sdVal" class="metric">‚Äî</div>
                  <div class="small-muted">Varianza</div><div id="varVal" class="metric">‚Äî</div>
                  <div class="small-muted">IQR</div><div id="iqrVal" class="metric">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="card-glass">
                <div class="small-muted">Distribuci√≥n binomial</div>
                <div class="row g-2">
                  <div class="col-6"><input id="binN" type="number" class="form-control" placeholder="n (ensayos)"></div>
                  <div class="col-6"><input id="binP" type="number" step="0.01" class="form-control" placeholder="p (0-1)"></div>
                  <div class="col-12"><button class="btn btn-success w-100 mt-2" onclick="calcBinomial()">Generar PMF</button></div>
                </div>
                <canvas id="chartBinomial" class="mt-3"></canvas>
              </div>
            </div>
          </div>

          <!-- charts row -->
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card-glass chart-card">
                <h6>Ventas vs Unidades (si se carg√≥ la base)</h6>
                <canvas id="scatterChart"></canvas>
                <div id="scatterMsg" class="small-muted mt-2">Cargar datos para ver esta gr√°fica.</div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-glass chart-card">
                <h6>Histograma ‚Äî Unidades</h6>
                <canvas id="histUnidades"></canvas>
                <div id="histMsg" class="small-muted mt-2">Cargar datos para ver esta gr√°fica.</div>
              </div>
            </div>
          </div>

        </div>

        <!-- SUPERVISOR -->
        <div id="supervisorView" class="hidden">
          <div class="card-glass mb-3">
            <h5>üîî Alertas y desviaciones</h5>
            <div id="alertList" class="mt-2 small-muted">Sin alertas</div>
          </div>
        </div>

        <!-- GERENTE -->
        <div id="gerenteView" class="hidden">
          <div class="card-glass mb-3">
            <h5>üìä Resumen semanal</h5>
            <div id="resumenBlock" class="mt-2 small-muted">Sin datos</div>
          </div>
        </div>

        <footer>Proyecto escolar ‚Äî F√°brica Alfa ¬∑ Equipo de Ingenier√≠a</footer>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // -------------------------
    // CONFIG & STATE
    // -------------------------
    const API_BASE = "http://127.0.0.1:8000"; // tu API local
    let loggedUser = null;
    let rawData = null; // guardamos DataFrame-like arrays aqu√≠
    let alerts = [];

    // Charts
    let binChart = null;
    let scatterChart = null;
    let histChart = null;

    // -------------------------
    // AUTH & NAV
    // -------------------------
    function showLogin(){ document.getElementById('loginModal').classList.remove('hidden'); }
    function doLogin(){
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value.trim();
      if((u === "admin" && p === "fabrica2025") || (u === "supervisor" && p === "control123")){
        loggedUser = u;
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('notLogged').classList.add('hidden');
        document.getElementById('logged').classList.remove('hidden');
        document.getElementById('userNameDisplay').innerText = u;
      } else {
        document.getElementById('loginMsg').innerText = "Usuario o contrase√±a incorrectos.";
      }
    }
    function logout(){
      loggedUser = null;
      document.getElementById('notLogged').classList.remove('hidden');
      document.getElementById('logged').classList.add('hidden');
      navTo('dashboard');
    }

    function navTo(page){
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('supervisorView').classList.add('hidden');
      document.getElementById('gerenteView').classList.add('hidden');
      if(page === 'dashboard') document.getElementById('dashboardView').classList.remove('hidden');
      if(page === 'supervisor'){
        document.getElementById('supervisorView').classList.remove('hidden');
        renderAlerts();
      }
      if(page === 'gerente'){
        document.getElementById('gerenteView').classList.remove('hidden');
        renderResumen();
      }
    }

    // -------------------------
    // API HELPERS
    // -------------------------
    async function pingAPI(){
      try{
        const r = await fetch(API_BASE + "/openapi.json");
        if(r.ok) {
          document.getElementById('apiStatus').innerText = "online";
          document.getElementById('apiStatus').style.color = "green";
        } else throw "no";
      }catch(e){
        document.getElementById('apiStatus').innerText = "offline";
        document.getElementById('apiStatus').style.color = "crimson";
      }
    }
    pingAPI();
    setInterval(pingAPI, 5000);

    // -------------------------
    // UPLOAD
    // -------------------------
    async function uploadFile(){
      const input = document.getElementById('fileInput');
      if(!input.files.length){ document.getElementById('uploadMsg').innerText = "Selecciona un archivo (.csv o .xlsx)"; return; }
      const file = input.files[0];
      const fd = new FormData();
      fd.append('archivo', file);
      document.getElementById('uploadMsg').innerText = "Cargando archivo...";
      try{
        const res = await fetch(API_BASE + "/cargar", { method: "POST", body: fd });
        const j = await res.json();
        if(j.mensaje){
          document.getElementById('uploadMsg').innerText = `OK: ${j.mensaje} ‚Äî columnas: ${j.columnas.join(', ')}`;
          // guardamos columnas info
          rawData = { columns: j.columnas };
          // try to fetch numeric arrays for scatter/hist if columns named 'Ventas' and 'Unidades'
          await fetchColumnArraysIfExist();
        } else {
          document.getElementById('uploadMsg').innerText = JSON.stringify(j);
        }
      }catch(err){
        document.getElementById('uploadMsg').innerText = "Error al cargar (ver consola)";
        console.error(err);
      }
    }

    // helper to ask API for column arrays (this endpoint may not exist; if it does not, API must implement it)
    async function fetchColumnArraysIfExist(){
      // try to request ventas and unidades arrays from endpoints if available
      try {
        const cols = rawData.columns.map(c => c.toLowerCase());
        let ventaCol = rawData.columns.find(c => /venta/i.test(c));
        let unidadCol = rawData.columns.find(c => /unidades?|unidad/i.test(c));
        if(!ventaCol || !unidadCol) return;

        // we'll call /dataarray/{col} (if you add this endpoint to the API it will return array)
        const r1 = await fetch(`${API_BASE}/dataarray/${encodeURIComponent(ventaCol)}`);
        const r2 = await fetch(`${API_BASE}/dataarray/${encodeURIComponent(unidadCol)}`);
        if(r1.ok && r2.ok){
          const ventasArr = await r1.json();
          const unidadesArr = await r2.json();
          rawData.ventas = ventasArr;
          rawData.unidades = unidadesArr;
          renderScatter(rawData.ventas, rawData.unidades);
          renderHist(unidadesArr);
        }
      } catch(e){ /* silently ignore if endpoint not present */ }
    }

    // -------------------------
    // CALCULOS: tendencia y dispersion
    // -------------------------
    async function calcTend(){
      const col = document.getElementById('colTend').value.trim();
      if(!col){ alert("Introduce nombre de columna (Ej: Ventas)"); return; }
      try {
        const r = await fetch(API_BASE + "/tendencia/" + encodeURIComponent(col));
        const j = await r.json();
        if(j.error){ alert(j.error); return; }
        document.getElementById('mediaVal').innerText = Number(j.media).toFixed(3);
        document.getElementById('medianaVal').innerText = Number(j.mediana).toFixed(3);
        document.getElementById('modaVal').innerText = (j.moda===null? "‚Äî": j.moda);
      } catch(e){ console.error(e); alert("Error al consultar API"); }
    }

    async function calcDisp(){
      const col = document.getElementById('colDisp').value.trim();
      if(!col){ alert("Introduce nombre de columna (Ej: Unidades)"); return; }
      try {
        const r = await fetch(API_BASE + "/dispersion/" + encodeURIComponent(col));
        const j = await r.json();
        if(j.error){ alert(j.error); return; }
        document.getElementById('sdVal').innerText = Number(j.desviacion).toFixed(3);
        document.getElementById('varVal').innerText = Number(j.varianza).toFixed(3);
        document.getElementById('iqrVal').innerText = Number(j.iqr).toFixed(3);
      } catch(e){ console.error(e); alert("Error al consultar API"); }
    }

    // -------------------------
    // BINOMIAL
    // -------------------------
    async function calcBinomial(){
      const n = parseInt(document.getElementById('binN').value);
      const p = parseFloat(document.getElementById('binP').value);
      if(isNaN(n) || isNaN(p)){ alert("Introduce n y p v√°lidos"); return; }
      try {
        const r = await fetch(API_BASE + `/binomial?n=${n}&p=${p}`);
        const j = await r.json();
        const labels = j.k;
        const pmf = j.pmf;
        renderBinomial(labels, pmf);
      } catch(e){ console.error(e); alert("Error al generar binomial"); }
    }

    // -------------------------
    // CHART RENDERERS
    // -------------------------
    function renderBinomial(labels, pmf){
      const ctx = document.getElementById('chartBinomial').getContext('2d');
      if(binChart) binChart.destroy();
      binChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: 'P(X=k)', data: pmf, backgroundColor:'#6a5af9' }]},
        options: { responsive:true, plugins:{ legend:{ display:false } } }
      });
    }

    function renderScatter(xs, ys){
      const ctx = document.getElementById('scatterChart').getContext('2d');
      document.getElementById('scatterMsg').classList.add('hidden');
      const data = xs.map((x,i)=>({ x: x, y: ys[i] }));
      if(scatterChart) scatterChart.destroy();
      scatterChart = new Chart(ctx, {
        type:'scatter',
        data: { datasets:[ { label:'Ventas vs Unidades', data:data, backgroundColor:'#00c2ff' } ] },
        options: { scales:{ x:{ title:{display:true,text:'Ventas'}}, y:{ title:{display:true,text:'Unidades'} } } }
      });
    }

    function renderHist(arr){
      const ctx = document.getElementById('histUnidades').getContext('2d');
      document.getElementById('histMsg').classList.add('hidden');
      // simple binning
      const min = Math.min(...arr), max=Math.max(...arr);
      const bins = 8;
      const step = (max-min)/bins;
      const labels = [], data = [];
      for(let i=0;i<bins;i++){
        const a = min + i*step, b = a+step;
        labels.push(`${Math.round(a)}-${Math.round(b)}`);
        const count = arr.filter(v => v>=a && v< b).length;
        data.push(count);
      }
      if(histChart) histChart.destroy();
      histChart = new Chart(ctx, {
        type:'bar',
        data:{ labels:labels, datasets:[ { label:'Frecuencia', data:data, backgroundColor:'#ff7ab6' } ] },
        options:{ plugins:{ legend:{display:false}}}
      });
    }

    // -------------------------
    // ALERTS & RESUMEN (simple)
    // -------------------------
    function renderAlerts(){
      const el = document.getElementById('alertList');
      if(alerts.length===0){ el.innerText = "Sin alertas"; return; }
      el.innerHTML = alerts.map(a=>`<div class="mb-2">${a}</div>`).join('');
    }
    function renderResumen(){
      const el = document.getElementById('resumenBlock');
      el.innerHTML = `<div>Registros cargados: ${rawData?.columns?.length || 0}</div>`;
    }
async function calcularTendencia() {
    const col = document.getElementById("columnaTendencia").value;

    const response = await fetch(`http://127.0.0.1:8000/tendencia/${col}`);
    const data = await response.json();

    console.log(data);
}
    // -------------------------
    // START - try to show UI
    // -------------------------
    (function init(){
      navTo('dashboard');
    })();
    async function cargarArchivo() {
    const fileInput = document.getElementById("archivo");
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    const response = await fetch("http://127.0.0.1:8000/cargar", {
        method: "POST",
        body: formData
    });

    const data = await response.json();
    console.log(data);
}
  </script>
</body>
</html>